<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Heat Map</title>
    <style>
      body {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
      }

      .cell {
        stroke: #000;
      }

      .tooltip {
        position: absolute;
        text-align: center;
        padding: 10px;
        background: lightsteelblue;
        border: 1px solid;
        border-radius: 5px;
        pointer-events: none;
      }

      svg {
        font: 10px sans-serif;
      }

      .axis path,
      .axis line {
        fill: none;
        shape-rendering: crispEdges;
      }

      .heatmap {
        font-family: sans-serif;
      }
    </style>
    <script src="https://d3js.org/d3.v6.min.js"></script>
  </head>

  <body>
    <h1 id="title">Monthly Global Land-Surface Temperature</h1>
    <h2 id="description">1753 - 2015: base temperature 8.66℃</h2>
    <div id="heatmap"></div>
    <script>
      // Set the dimensions and margins of the graph
      const margin = {
          top: 100,
          right: 30,
          bottom: 100,
          left: 100,
        },
        width = 1200 - margin.left - margin.right,
        height = 500 - margin.top - margin.bottom;

      // Parse the Data
      d3.json(
        "https://raw.githubusercontent.com/freeCodeCamp/ProjectReferenceData/master/global-temperature.json"
      ).then((data) => {
        const baseTemp = data.baseTemperature;
        const monthlyVariance = data.monthlyVariance;

        // Append the svg object to the heatmap div
        const svg = d3
          .select("#heatmap")
          .append("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
          .append("g")
          .attr("transform", `translate(${margin.left},${margin.top})`);

        // Labels of row and columns
        const years = [...new Set(monthlyVariance.map((d) => d.year))]; // Unique years
        const months = [
          "January",
          "February",
          "March",
          "April",
          "May",
          "June",
          "July",
          "August",
          "September",
          "October",
          "November",
          "December",
        ];

        // Build X scales and axis
        const x = d3.scaleBand().range([0, width]).domain(years).padding(0.01);

        svg
          .append("g")
          .attr("id", "x-axis")
          .attr("transform", `translate(0, ${height})`)
          .call(
            d3
              .axisBottom(x)
              .tickValues(d3.range(1760, 2020, 10))
              .tickFormat(d3.format("d"))
          );

        // Build Y scales and axis
        const y = d3
          .scaleBand()
          .range([height, 0])
          .domain(months)
          .padding(0.01);

        svg.append("g").attr("id", "y-axis").call(d3.axisLeft(y));

        // Build color scale
        const colorScale = d3
          .scaleQuantize()
          .domain([
            d3.min(monthlyVariance, (d) => baseTemp + d.variance),
            d3.max(monthlyVariance, (d) => baseTemp + d.variance),
          ])
          .range(["#d73027", "#fc8d59", "#fee08b", "#d9ef8b", "#91cf60"]);

        // Tooltip
        const tooltip = d3
          .select("body")
          .append("div")
          .attr("class", "tooltip")
          .attr("id", "tooltip")
          .style("opacity", 0);

        // Create rectangles
        svg
          .selectAll(".cell")
          .data(monthlyVariance)
          .enter()
          .append("rect")
          .attr("x", (d) => x(d.year))
          .attr("y", (d) => y(months[d.month - 1]))
          .attr("class", "cell")
          .attr("data-month", (d) => d.month - 1)
          .attr("data-year", (d) => d.year)
          .attr("data-temp", (d) => baseTemp + d.variance)
          .attr("width", x.bandwidth())
          .attr("height", y.bandwidth())
          .style("fill", (d) => colorScale(baseTemp + d.variance))
          .on("mouseover", (event, d) => {
            tooltip
              .style("opacity", 1)
              .attr("data-year", d.year)
              .html(
                `Year: ${d.year}<br>Month: ${
                  months[d.month - 1]
                }<br>Temperature: ${baseTemp + d.variance}℃`
              )
              .style("left", event.pageX + 5 + "px")
              .style("top", event.pageY - 28 + "px");
          })
          .on("mouseout", () => tooltip.style("opacity", 0));

        // Add legend
        const legend = svg
          .append("g")
          .attr("id", "legend")
          .attr("transform", `translate(0, ${height + 50})`);

        const legendColors = colorScale.range();
        legend
          .selectAll("rect")
          .data(legendColors)
          .enter()
          .append("rect")
          .attr("x", (d, i) => i * 80)
          .attr("y", 0)
          .attr("width", 80)
          .attr("height", 20)
          .style("fill", (d) => d);
      });
    </script>
    <script src="https://cdn.freecodecamp.org/testable-projects-fcc/v1/bundle.js"></script>
  </body>
</html>
