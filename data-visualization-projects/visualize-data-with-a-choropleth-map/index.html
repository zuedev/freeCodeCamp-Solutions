<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Choropleth Map</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="https://d3js.org/topojson.v1.min.js"></script>
    <style>
      body {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
      }
      body {
        font-family: Arial, sans-serif;
      }
      .county {
        stroke: #fff;
        stroke-width: 0.5px;
      }
      .legend {
        font-family: sans-serif;
        font-size: 12px;
      }
      .tooltip {
        position: absolute;
        text-align: center;
        width: auto;
        height: auto;
        padding: 5px;
        font: 12px sans-serif;
        background: lightsteelblue;
        border: 0px;
        border-radius: 8px;
        pointer-events: none;
      }
    </style>
  </head>
  <body>
    <h1 id="title">Educational Attainment in the United States</h1>
    <p id="description">
      Percentage of adults age 25 and older with a bachelor's degree or higher
      (2010-2014)
    </p>
    <div id="chart"></div>
    <div id="legend"></div>
    <div id="tooltip"></div>
    <script src="https://cdn.freecodecamp.org/testable-projects-fcc/v1/bundle.js"></script>
    <script>
      async function loadData() {
        const countyDataUrl =
          "https://cdn.freecodecamp.org/testable-projects-fcc/data/choropleth_map/counties.json";
        const educationDataUrl =
          "https://cdn.freecodecamp.org/testable-projects-fcc/data/choropleth_map/for_user_education.json";

        const countyData = await (await fetch(countyDataUrl)).json();
        const educationData = await (await fetch(educationDataUrl)).json();

        return { countyData, educationData };
      }

      function drawMap({ countyData, educationData }) {
        const width = 960;
        const height = 600;

        const svg = d3
          .select("#chart")
          .append("svg")
          .attr("width", width)
          .attr("height", height);

        const path = d3.geoPath();

        const color = d3
          .scaleThreshold()
          .domain(d3.range(2, 70, 10))
          .range(d3.schemeBlues[9]);

        svg
          .append("g")
          .selectAll("path")
          .data(
            topojson.feature(countyData, countyData.objects.counties).features
          )
          .enter()
          .append("path")
          .attr("class", "county")
          .attr("d", path)
          .attr("fill", (d) => {
            const result = educationData.filter((obj) => obj.fips === d.id);
            return result[0] ? color(result[0].bachelorsOrHigher) : color(0);
          })
          .attr("data-fips", (d) => d.id)
          .attr("data-education", (d) => {
            const result = educationData.filter((obj) => obj.fips === d.id);
            return result[0] ? result[0].bachelorsOrHigher : 0;
          })
          .on("mouseover", function (event, d) {
            const result = educationData.filter((obj) => obj.fips === d.id)[0];
            d3.select("#tooltip")
              .style("opacity", 0.9)
              .style("left", event.pageX + 5 + "px")
              .style("top", event.pageY - 28 + "px")
              .attr("data-education", result.bachelorsOrHigher)
              .html(
                result.area_name +
                  ", " +
                  result.state +
                  ": " +
                  result.bachelorsOrHigher +
                  "%"
              );
          })
          .on("mouseout", function () {
            d3.select("#tooltip").style("opacity", 0);
          });

        const legend = d3
          .select("#legend")
          .append("svg")
          .attr("width", 400)
          .attr("height", 40)
          .selectAll("g")
          .data(
            color.range().map(function (d) {
              d = color.invertExtent(d);
              if (d[0] === null) d[0] = 0;
              if (d[1] === null) d[1] = 100;
              return d;
            })
          )
          .enter()
          .append("g")
          .attr("transform", (d, i) => `translate(${i * 40}, 0)`);

        legend
          .append("rect")
          .attr("width", 40)
          .attr("height", 20)
          .attr("fill", (d) => color(d[0]));

        legend
          .append("text")
          .attr("x", 20)
          .attr("y", 30)
          .attr("dy", ".35em")
          .attr("text-anchor", "middle")
          .text((d) => Math.round(d[0]));
      }

      const tooltip = d3
        .select("body")
        .append("div")
        .attr("id", "tooltip")
        .attr("class", "tooltip");

      loadData().then((data) => {
        drawMap(data);
      });
    </script>
  </body>
</html>
